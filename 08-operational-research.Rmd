# Operational Research

## Discrete Event Simulations
The example below is a based on examples provided in the _simmer_ website.

```{r 08-operational-research-1}
library(simmer)
library(parallel)
library(simmer.plot)
NUM_ANGIO <- 1  # Number of machines for performing ECR
ECRTIME <- 1     # hours it takes to perform ECR~ 90/60
T_INTER <- 13 # new patient every ~365*24/700 hours
SIM_TIME <- 24*30     # Simulation time in 30 days
# setup
set.seed(42)
env <- simmer()
patient <- trajectory() %>%
  log_("arrives at the ECR") %>%
  seize("removeclot", 1) %>%
  log_("enters the ECR") %>%
  timeout(ECRTIME) %>%
  set_attribute("clot_removed", function() sample(50:99, 1)) %>%
  log_(function() 
    paste0(get_attribute(env, "clot_removed"), "% of clot was removed")) %>%
  release("removeclot", 1) %>%
  log_("leaves the ECR")
env %>%
  add_resource("removeclot", NUM_ANGIO) %>%
  # feed the trajectory with 4 initial patients
  add_generator("patient_initial", patient, at(rep(0, 4))) %>%
  # new patient approx. every T_INTER minutes
  add_generator("patient", patient, function() sample((T_INTER-2):(T_INTER+2), 1)) %>%
  # start the simulation
  run(SIM_TIME)
plot(patient)
resource <- get_mon_resources(env)
plot(resource)
sum(resource$queue) #total queue size
sum(resource$queue==2) #number of people in queue
sum(resource$queue==1)
#View(get_mon_arrivals(env))
plot(env,what="arrivals",metric="flow_time")
```

## Linear Programming

There are several different libraries useful for linear programming. The _lpSolve_ library is used here as illustration.

```{r 08-operational-research-2}
library(lpSolve)

#solve using linear programming
n <-2.5 # Numbers of techs
set_up_eeg <- 40 # min
to_do_eeg <- 30 # min
clean_equipment <- 10 #min
annotate_eeg <- 10 #min

# put some error for EEG time
# if error=1 that mean NO errors happen
error <- 0.8 #change from 0.93

#Calculate time for EEG in hour
eeg_case_time <- ((set_up_eeg+to_do_eeg+clean_equipment+annotate_eeg)/60)*error

# limit for EEG per day
# we can put different limits for EEGs
limit_eeg <- round(8*eeg_case_time, digits = 0)

#s[i] - numbers of cases for each i-EEG's machines 
#Setting the coefficients of s[i]-decision variables
#In a future can put some efficiency or some cost
objective.in=c(1,1,1,1,1)

#Constraint Matrix
const.mat=matrix(c(1,0,0,0,0,
                   0,1,0,0,0,
                   0,0,1,0,0,
                   0,0,0,1,0,
                   0,0,0,0,1,
                   1,1,1,1,1),nrow = 6,byrow = T)

#defining constraints
const_num_1=limit_eeg  #in cases
const_num_2=limit_eeg  #in cases
const_num_3=limit_eeg  #in cases
const_num_4=limit_eeg  #in cases
const_num_5=limit_eeg  #in cases
const_res= n*7 # limit per sessions

#RHS for constraints
const.rhs=c(const_num_1,const_num_2,const_num_3,const_num_4,const_num_5, const_res)

#Direction for constraints
constr.dir <- rep("<=",6)

#Finding the optimum solution
opt=lp(direction = "max",objective.in,const.mat,constr.dir,const.rhs)
#summary(opt)

#Objective values of s[i]

opt$solution 
  
  
```
#Estimate for day (Value of objective function at optimal point)
```{r 08-operational-research-2-1, echo=FALSE, message=FALSE}
opt$objval

#Urgent cases estimate

saturday <-2
sunday <- 2

```

#Estimate EEG per month based on staff EFT- only 3.5 of 5.7

```{r 08-operational-research-2-2, echo=FALSE, message=FALSE}
estimate_week <- 5*opt$objval + saturday + sunday
estimate_month <- 4*estimate_week
estimate_month
```

## Plots

The median number of hours per fortnight is 127 + 8 (for urgent EEG)
The median number of sessions is 36 + 4 for weekend

```{r 08-operational-research-2-3}
t=c(189.9370, 168.4725, 186.1128, 194.3047, 193.2593, 184.1915, 174.7920, 176.8964, 204.1324, 190.5459, 187.4211, 181.3592, 188.0941, 173.4730, 183.4212, 181.8803, 197.2092, 183.0857, 174.7203, 149.6084, 178.6238, 178.2982, 179.9899, 180.5452, 165.4464, 175.8635, 188.0470, 187.1038, 176.0725, 189.5796, 184.8708, 197.6775, 179.7429, 184.8719, 174.9163, 194.0854, 178.4370, 189.0127, 191.6685, 168.9936, 170.7558, 182.9075, 173.2931, 161.7117, 166.2627, 176.6619, 187.4424, 196.0481, 170.1041, 201.6837, 206.3890, 183.1897, 187.7450, 170.2805, 200.0915, 172.9868, 179.6910, 189.4723, 190.2622, 154.0683, 191.1630, 187.4863, 177.4675, 200.0806)

num_sessions=t/5
  
# Time spend on a report by neurologists (1 report = 30 min)
neurologists_h <- num_sessions*3.5
#print(neurologists_h)

# Histogram for Estimate Neurologists Time, hours per 2 weeks
hist(neurologists_h,
     main="Estimate Neurologists Time, hours per 2 weeks",
     xlab="Hours per 2 weeks",
     col="magenta")
text(135, 15, paste0("Neurologist Hours=", " " , round(median(neurologists_h))))

```

## Forecasting

Forecasting is useful in predicting trends. In health care it can be used for estimating seasonal trends and bed requirement. Below is a forecast of mortality from COVID-19 in 2020. This forecast is an example and is not meant to be used in practice as mortality from COVID depends on the number of factors including infected cases, age, socioeconomic group, and comorbidity. 


```{r 08-operational-research-3}
library(tidyverse)
library(prophet)
library(hrbrthemes)
library(lubridate)
library(readr) #use read_csv to read csv rather than base R

covid<-read_csv("./Data-Use/Covid_Table100420.csv") 
colnames(covid)

# A data frame with columns ds & y (datetimes & metrics)
covid<-rename(covid, ds =Date, y=Total.Deaths)
covid2 <- covid[c(1:12),]

m<-prophet(covid2)#create prophet object
# Extend dataframe 12 weeks into the future
future <- make_future_dataframe(m, freq="week" , periods = 26)
# Generate forecast for next 500 days
forecast <- predict(m, future)

# What's the forecast for July 2020?
forecasted_rides <- forecast %>%
  arrange(desc(ds)) %>%
  dplyr::slice(1) %>%
  pull(yhat) %>%
  round()
forecasted_rides

# Visualize
forecast_p <- plot(m, forecast) + 
  labs(x = "", 
       y = "mortality", 
       title = "Projected COVID-19 world mortality", 
       subtitle = "based on data truncated in January 2020") +
        ylim(20000,80000)+
  theme_ipsum_rc()
#forecast_p

```

### Bed requirement

### Length of stay

### Customer churns

Customer churns or turnover is an issue of interest in marketing. The corollary within healthcare are patients attendance at outpatient clinics, Insurance. The classical method used is GLM.


## Process mapping

```{r 08-operational-research-4}
library(DiagrammeR)
a.plot<-mermaid("
        graph TB
        
        A((Triage))
        A-->|2.3 hr|B(Imaging-No Stroke Code)
        A-->|0.6 hr|B1(Imaging-Stroke Code)
        
        B-->|14.6 hr|B2(Dysphagia Screen)
        B1-->|no TPA 10.7 hr|B2(Dysphagia Screen)

        C(Stop NBM)
        B2-->|0 hr|C
      
        C-->|Oral route 1.7 hr|E{Antithrombotics}
        
        D1-->|7.5 hr|E
        B-->|PR route 6.8 hr|E
        B1-->|PR route 3.8 hr|E
    
        B1-->|TPA 24.7 hr|D1(Post TPA Scan)
    
        style A fill:#ADF, stroke:#333, stroke-width:2px
        style B fill:#9AA, stroke:#333, stroke-width:2px
        style B2 fill:#9AA, stroke:#333, stroke-width:2px
        style B1 fill:#879, stroke:#333, stroke-width:2px
        style C fill:#9AA, stroke:#333, stroke-width:2px
        style D1 fill:#879, stroke:#333, stroke-width:2px
        style E fill:#9C2, stroke:#9C2, stroke-width:2px
        ") 
a.plot
```

```{r 08-operational-research-5}
library(bupaR)
```

## Supply chains

## Health economics

### Cost

```{r 08-operational-research-6}

library("hesim")
library("data.table")

strategies <- data.table(strategy_id = c(1, 2))
n_patients <- 1000
patients <- data.table(patient_id = 1:n_patients,
          age = rnorm(n_patients, mean = 70, sd = 10),
          female = rbinom(n_patients, size = 1, prob = .4))
states <- data.table(state_id = c(1, 2),
                     state_name = c("Healthy", "Sick")) 
# Non-death health states
tmat <- rbind(c(NA, 1, 2),
              c(3, NA, 4),
              c(NA, NA, NA))
colnames(tmat) <- rownames(tmat) <- c("Healthy", "Sick", "Dead")
transitions <- create_trans_dt(tmat)
transitions[, trans := factor(transition_id)]
hesim_dat <- hesim_data(strategies = strategies,
                        patients = patients, 
                        states = states,
                        transitions = transitions)
print(hesim_dat)
```

Data from WHO on mortality rate can be extracted directly from WHO or by calling _get_who_mr_ in _heemod_ library.

```{r 08-operational-research-7}

library(heemod)

```

There are several data in BCEA library.

```{r 08-operational-research-8}
library(BCEA)

#use Vaccine data from BCEA
data(Vaccine,package = "BCEA")

ints=c("Standard care","Vaccination")

m <- bcea(e,c,ref=2,interventions=ints)

summary(m)
```